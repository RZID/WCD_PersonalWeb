version: 2.1

executors:
  node-executor:
    docker:
      - image: cimg/node:22.14.0
    working_directory: /home/circleci/project

jobs:
  build:
    executor: node-executor
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-yarn-deps-{{ checksum "yarn.lock" }}

      - run:
          name: Install dependencies
          command: yarn install --frozen-lockfile

      - save_cache:
          key: v1-yarn-deps-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn

      - run:
          name: Build project
          command: yarn build

      - persist_to_workspace:
          root: .
          paths:
            - dist

  deploy:
    executor: node-executor
    steps:
      - attach_workspace:
          at: /home/circleci/project

      - add_ssh_keys:
          fingerprints:
            - "SHA256:W626Um9048Sg67sSH//pI9wCwngSjBLf/34HL/EiOtI"
      - run:
          name: Deploy to Server
          command: |
            set -e

            echo "ðŸ“¦ Deploying build to server..."

            ssh -o StrictHostKeyChecking=no -p 2242 web@159.223.54.215 \<< 'EOF'
              cd /home/rzidinc/docker/web/html/wcd/personal_web

              find . -mindepth 1 -maxdepth 1 \
                ! -name '.env' \
                ! -name '.gitkeep' \
                -exec rm -rf {} +

              echo "ðŸ§¹ Old files cleaned"
            EOF

            scp -P 2242 -r /home/circleci/project/dist/* \
              web@159.223.54.215:/home/rzidinc/docker/web/html/wcd/personal_web

            echo "ðŸš€ Deploy finished successfully"

workflows:
  build_and_deploy:
    jobs:
      - build:
          filters:
            branches:
              only:
                - main

      - deploy:
          requires:
            - build
          filters:
            branches:
              only:
                - main
