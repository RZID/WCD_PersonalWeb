version: 2.1

executors:
  node-executor:
    docker:
      - image: cimg/node:22.14.0
    working_directory: /home/circleci/project

jobs:
  build:
    executor: node-executor
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-yarn-deps-{{ checksum "yarn.lock" }}

      - run:
          name: Install dependencies
          command: yarn install --frozen-lockfile

      - save_cache:
          key: v1-yarn-deps-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn

      - run:
          name: Build project
          command: yarn build

      - persist_to_workspace:
          root: .
          paths:
            - dist

  deploy:
    executor: node-executor
    steps:
      - attach_workspace:
          at: /home/circleci/project

      - add_ssh_keys:
          fingerprints:
            - "SHA256:F7kcxReB0Dsb6fZFSmhEN7rMgnoUpMLITuyS2iRMC7g"
      - run:
          name: Deploy to College Nginx
          command: |
            APP_NAME="cu-disc03-uas"
            DEPLOY_PATH="/disc03/uas"
            DOMAIN="college.rzidinc.com"
            SERVER_USER="web"
            SERVER_IP="159.223.54.215"
            SSH_PORT="2242"

            # PATH
            TARGET_DIR="/home/$SERVER_USER/college/sites/$APP_NAME"

            echo "üéì Deploying: $APP_NAME"
            echo "üìÅ To: $TARGET_DIR"
            echo "üåê URL: http://$DOMAIN:8002$DEPLOY_PATH"

            # 1. Clean directory
            ssh -p $SSH_PORT $SERVER_USER@$SERVER_IP "
              # Safety check
              if [[ \"$TARGET_DIR\" == \"/home\"* ]] && [[ \"$TARGET_DIR\" != \"/home\" ]] && [[ \"$TARGET_DIR\" != \"/home/\" ]]; then
                mkdir -p \"$TARGET_DIR\"
                cd \"$TARGET_DIR\" && rm -rf ./* ./.* 2>/dev/null || true
                echo '‚úÖ Directory cleaned'
              else
                echo '‚ùå ERROR: Please check your target directory!'
                exit 1
              fi
            "

            # 2. Upload build files
            echo "üì§ Uploading React build..."
            scp -P $SSH_PORT -r /home/circleci/project/dist/* \
              $SERVER_USER@$SERVER_IP:"$TARGET_DIR/"

            # 3. Configure nginx
            echo "‚öôÔ∏è Configuring Nginx..."
            ssh -p $SSH_PORT $SERVER_USER@$SERVER_IP "
              docker exec nginx-college /deploy-script.sh \
                '$APP_NAME' \
                '$DEPLOY_PATH' \
                '$DOMAIN'
            "

            echo ""
            echo "‚úÖ DEPLOYMENT COMPLETE!"
            echo "üëâ http://$DOMAIN:8002$DEPLOY_PATH"

workflows:
  build_and_deploy:
    jobs:
      - build:
          filters:
            branches:
              only:
                - main

      - deploy:
          requires:
            - build
          filters:
            branches:
              only:
                - main
